<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>User</title>
    <link href="/css/bootstrap.css" rel="stylesheet"/>
    <link href="/css/style.css" rel="stylesheet"/>
    <link href="/css/buttons.css" rel="stylesheet"/>
    <link href="/css/fontawesome-all.css" rel="stylesheet"/>
</head>

<body style="background-color: #f1f1f1; padding-bottom: 0">

<div class="container col-sm-4 col-sm-offset-4" style="position: absolute;padding-top: 50px;display: none">
    <div class="imageBox">
    </div>
</div>

<div th:insert="~{header :: nav}"></div>

<div th:if="${message} != null" class="col-12 col-sm-10 col-sm-offset-1" style="margin-top: 40px">
    <div class="bctmsg" style="text-align: center">
        <p th:text="${message}"></p>
    </div>

</div>

<div class="container" style="margin-top: 60px">

    <div style="text-align: center; margin-top: 5%" id="avatarDiv" th:if="${user} != null">
        <img th:src="'/image/users/'+${user.getId()}+'_image.jpg'" alt="avatar" id="avatar" class="img-circle"
             th:name="'/image/users/'+${user.getId()}+'_image.jpg'" style="margin: 0 auto;height: 250px">
        <p th:text="${user.getUsername()}" style="margin-top: 25px; font-size: 20px; color: crimson">Sun</p>
        <div class="col-xs-12 col-sm-offset-4 col-sm-4">
            <form th:action="@{/logout}" method="post" class="col-xs-12 col-sm-4 "
                  style=" margin-top: 20px">
                <button class="button button-small button-rounded button-caution">Logout</button>
            </form>
            <form class="col-xs-12 col-sm-4" style="margin-top: 20px">
                <button type="button" id="uploadbtn"
                        class="button button-small button-rounded button-royal uspotrait">Portrait
                </button>
            </form>
            <form class="col-xs-12 col-sm-4" style="margin-top: 20px">
                <button type="button" id="ordersbtn"
                        class="button button-small button-rounded button-highlight usorders"
                        onclick="getOrders()">Orders
                </button>
            </form>
        </div>
    </div>

    <div id="ordersDiv" th:if="${orders} != null" style="padding-top: 50px">
        <div class="row col-xs-offset-1" >
            <button onclick="goBack()" class="button  button-rounded button-royal button-small burcmbtn" >Back</button>
        </div>

        <div class="col-xs-12 col-sm-4 OrderDiv" th:each="oitem:${orders}" name="OrderDiv" style="padding-top: 30px" >
            <div>
            <div class="receipt col-xs-12" >
                <div th:each="oitemid:${oitem.key}">
                    <h2 class="receipt__title" th:text="'OrderID: '+${oitemid.key}"></h2>
                </div>
                <div th:each="oitemid:${oitem.key}">
                    <p class="receipt__subtitle" th:text="${oitemid.value.get(0)}"></p>
                </div>

                <ul class="receipt__lines" th:each="list:${oitem.value}">
                    <li class="receipt__line" th:each="item: ${list.key}">
                        <span class="receipt__line__item" th:text="${item.key} + '('+ ${item.value.get(0)}+')'"></span>
                        <span class="receipt__line__price" th:text="'$'+${item.value.get(1)}"></span>
                    </li>
                </ul>
                <div th:each="list:${oitem.value}" class="col-12">
                    <p class="receipt__total">
                        <span class="receipt__total__item">Total：</span>
                        <span class="receipt__total__price" th:text="'$'+${list.value}"></span>
                    </p>
                </div>
                <div th:each="oitemid:${oitem.key}">
                <p class="receipt__back">
                    <a class="magic" th:text="${oitemid.value.get(1)}" style="text-decoration:none"></a>
                </p>
                </div>
            </div>
            </div>
        </div>
    </div>
</div>


<div id="uploadDiv" style="display: none;padding-top: 50px">
    <div class="row col-xs-offset-1">
        <button onclick="goBack()" class="button  button-rounded button-royal button-small burcmbtn" >Back</button>
    </div>
    <div class="row" >
        <div class="imageBox col-sm-4 col-sm-offset-4">
            <div class="thumbBox"></div>
            <div class="spinner" style="display: none"></div>
        </div>
    </div>
    <div class="row" style="text-align: center; padding-top:20px;">
        <label class="ui_button ui_button_primary" for="file">Choose File</label>
        <form><input type="file" id="file" name="imageName" style="position:absolute;clip:rect(0 0 0 0)"></form>
    </div>
    <div class="row col-sm-4 col-sm-offset-4" style="text-align: center;padding-top:15px">
        <div class="burbtns">
            <button type="button" class="button button-small  button-plain button-border button-circle burcmbtn"
                    id="btnZoomIn">
                <i class="fa fa-plus"></i>
            </button>
            <button type="button" class="button button-small button-rounded button-highlight" id="btnCommit">
                Commit
            </button>
            <button type="button" class="button button-small  button-plain button-border button-circle burcmbtn"
                    id="btnZoomOut">
                <i class="fa fa-minus"></i>
            </button>
        </div>
    </div>

</div>
</div>
</body>
<script src="/js/jquery-3.3.1.min.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/cropbox.js"></script>
<script type="text/javascript">

    window.onload=function(){
        var divs = document.getElementsByName("OrderDiv");

        var maxheight = 0;
        for (i=0;i<divs.length;i+=3){
            if (i === divs.length-1)
                break;
            else if (i+1 === divs.length-1) {
                maxheight = Math.max(divs[i].offsetHeight, divs[i+1].offsetHeight);
                divs[i].style.height = maxheight;
                divs[i+1].style.height = maxheight;
                break;
            }
            else{
                maxheight = Math.max(divs[i].offsetHeight, divs[i+1].offsetHeight, divs[i+2].offsetHeight);
                divs[i].style.height = maxheight;
                divs[i+1].style.height = maxheight;
                divs[i+2].style.height = maxheight;
                maxheight = 0;
            }
        }
    };

    $('.imageBox').hover(
        function () {
            var top = $('body').scrollTop();
            $(window).scroll(function () { //滚动时，固定页面滚动条到页顶的高度，使其不滚动
                $('body').scrollTop(top);
            });
        }, function () {
            $(window).off('scroll'); //鼠标移开后，解除固定
        });

    $(document).ready(function () {
        var options =
            {
                thumbBox: '.thumbBox',
                spinner: '.spinner',
                imgSrc: ''
            };
        var cropper;

        $('#uploadbtn').on('click', function () {
            document.getElementById("uploadDiv").style.display = "";
            options.imgSrc = document.getElementById('avatar').name;
            cropper = $('.imageBox').cropbox(options);
            document.getElementById("avatarDiv").style.display = "none";
        });
        $('#file').on('change', function () {
            var reader = new FileReader();
            reader.onload = function (e) {
                options.imgSrc = e.target.result;
                cropper = $('.imageBox').cropbox(options);
            };
            reader.readAsDataURL(this.files[0]);
            this.files = [];
        });

        $('#btnCommit').on('click', function () {
            var imgcode = cropper.getDataURL();
            $.get("/user/uploadImage", {imgcode: imgcode}, function (data, status) {
            });
            document.getElementById("uploadDiv").style.display = "none";
            document.getElementById("avatarDiv").style.display = "";
        });

        $('#btnZoomIn').on('click', function () {
            cropper.zoomIn();
        });
        $('#btnZoomOut').on('click', function () {
            cropper.zoomOut();
        })
    });

    function getOrders() {
        window.location.href = '/user/orders';
    }

    function goBack() {
        window.location.href = "/user";
    }

</script>

</html>
